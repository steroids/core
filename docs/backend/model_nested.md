# Сохранение вложенной структуры данных

В Yii2 для сохранения связанных данных есть метолы `link()` и `unlink()`. Их использование предполагает предварительное
создание всех экземпляров моделей и поддерживает только `hasOne` и `hasMany` связи.

Часто с фронтенда приходит большой объект с вложенными данных, например:

```json
{
  "title": "Название",
  "tagsIds": [16, 29, 11],
  "items": [
    {
      "label": "",
      "categoriesIds": [1, 4]
    },
    {
      "label": "...",
      "categoriesIds": [1]
    }
  ],
  "modes": [
    {
      "id": 55,
      "name": "..."
    }
  ]
}
```

В данном примере связанные данные - это ID тегов, вложенный массив `items` (внутри которого есть вложенный массив
с ID `categories`) и массив `modes`. Если в моделях объявлены соответствующие связи (relations) `tags`, `items` и
`modes`, а у `item` еще есть связь с `categories`, то сохранение будет выглядеть следующим образом:

```php
$article = new MyModel();
$article->listenRelationIds(['tags', 'items.categories']); // Указываем модели по каким связям ожидать данных
$article->listenRelationData('modes');
$article->load(Yii::$app->request->post());
$article->save();
```

Каждая модель использует трейт `\steroids\core\traits\RelationSaveTrait`, который позволяет загрузить связанные данные
(load), провести валидацию (validate) и сохранить в БД (save). Трейт сам увидит все типы связей (в том числе many-many),
создаст (или найдет, если передан `PK`) все экземпляры моделей, проставит в связующие модели созданные `Primary Key`
и транзакционно сохранит все в базу данных. При этом вложенность данных может быть неограниченной.

Если какое-то из полей не пройдет валидацию (в том числе вложенных), то сохранение не произойдет, а метод `getErrors()`
будет выдавать массив ошибок, структура которого будет соответствовать входящим данным, например:

```json

{
  "errors": {
    "items": {
      "1": {
        "label": ["Заполните название"]
      }
    }
  }
}
```